version: classificator-v1
krtVersion: v2
description: Demo email classificator for branching features.
entrypoint:
  proto: public_input.proto
  image: konstellation/kre-entrypoint:latest
config:
  variables:
workflows:
  - name: classificator
    entrypoint: Classificator
    exitpoint: exitpoint
    nodes:
      - name: etl
        image: konstellation/kre-py:latest
        src: src/etl/main.py
        subscriptions:
          - 'entrypoint'

      - name: email-classificator
        image: konstellation/kre-py:latest
        src: src/email_classificator/main.py
        subscriptions:
          - 'etl'

      - name: repairs-handler
        image: konstellation/kre-go:latest
        src: bin/repairs_handler
        subscriptions:
          - 'email-classificator.repairs'

      - name: stats-storer
        image: konstellation/kre-go:latest
        src: bin/stats_storer
        objectStore:
          name: emails
          scope: workflow
        subscriptions:
          - 'email-classificator'

      - name: exitpoint
        image: konstellation/kre-go:latest
        src: bin/exitpoint
        objectStore:
          name: emails
          scope: workflow
        subscriptions:
          - 'etl'
          - 'stats-storer'

  - name: batch-classificator
    entrypoint: BatchClassificator
    exitpoint: exitpoint
    nodes:
      - name: etl
        image: konstellation/kre-go:latest
        src: bin/etl
        objectStore:
          name: emails
          scope: workflow
        subscriptions:
          - 'entrypoint'

      - name: batch-classificator
        image: konstellation/kre-go:latest
        src: bin/batch_email_classificator
        objectStore:
          name: emails
          scope: workflow
        subscriptions:
          - 'etl'

      - name: repairs-handler
        image: konstellation/kre-go:latest
        src: bin/repairs_handler
        subscriptions:
          - 'batch-classificator.repairs'

      - name: stats-storer
        image: konstellation/kre-go:latest
        src: bin/stats_storer
        objectStore:
          name: emails
          scope: workflow
        subscriptions:
          - 'batch-classificator'

      - name: exitpoint
        image: konstellation/kre-go:latest
        src: bin/exitpoint
        objectStore:
          name: emails
          scope: workflow
        subscriptions:
          - 'etl'
          - 'stats-storer'